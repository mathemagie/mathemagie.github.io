<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animation Parapluie - Vue du Haut</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #0F0F0F; /* Noir élégant pour effet dramatique */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: Arial, sans-serif;
        }
        #sketch-container {
            /* Bordure et ombre retirées pour un look plus propre */
            cursor: pointer; /* Curseur pointer pour indiquer l'interactivité */
            transition: opacity 0.3s ease; /* Transition douce pour les effets */
        }

        .canvases-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, 100px);
            gap: 10px;
            justify-content: center;
            padding: 10px;
            max-width: 100vw;
            box-sizing: border-box;
        }

        .canvas-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100px;
            height: 100px;
        }

        .canvas-wrapper div[id^="sketch-container-"] {
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .canvas-wrapper div[id^="sketch-container-"]:hover {
            opacity: 0.95;
        }
        .title {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #ecf0f1;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>
    <div id="canvases-container" class="canvases-container"></div>

    <script>
        // Fonction pour créer une animation de parapluie
        function createUmbrellaAnimation(containerId) {
            return new p5((p) => {
                // Variables locales pour cette instance
                let centerX, centerY;
                let umbrellaRadius = 45; // Divisé par 2 pour s'adapter au canvas 100x100
                let handleRadius = 8;
                let numSegments = 8;

                let animationState = 'closed';
                let currentOpenFactor = 0;
                let targetOpenFactor = 0;
                let animationSpeed = 0.02;
                let animationActive = false;

                let segmentDelays = [];
                let bounceFactor = 0;
                let lastStateChange = 0;

                // Couleurs extraites du parapluie rouge de l'image
                let colors = [
                    '#DC2626', // Rouge principal intense
                    '#EF4444', // Rouge vif
                    '#F87171', // Rouge plus clair  
                    '#FCA5A5', // Rouge pastel
                    '#B91C1C', // Rouge foncé
                    '#991B1B', // Rouge très foncé
                    '#7F1D1D', // Rouge bordeaux
                    '#450A0A'  // Rouge très sombre
                ];

                p.setup = function() {
                    let canvas = p.createCanvas(100, 100);
                    canvas.parent(containerId);

                    centerX = p.width / 2;
                    centerY = p.height / 2;

                    p.angleMode(p.DEGREES);

                    for (let i = 0; i < numSegments; i++) {
                        segmentDelays[i] = i * 0.05;
                    }
                };

                p.draw = function() {
                    updateAnimation();
                    drawBackground();
                    drawUmbrella(currentOpenFactor);
                    drawHandle();
                };

                function updateAnimation() {
                    let mouseIsOver = p.mouseX >= 0 && p.mouseX <= p.width && p.mouseY >= 0 && p.mouseY <= p.height;

                    if (mouseIsOver) {
                        if (animationState !== 'closing' && animationState !== 'closed') {
                            if (!animationActive) {
                                animationActive = true;
                                lastStateChange = p.millis();
                            }

                            if (animationState === 'open') {
                                startClosing();
                                lastStateChange = p.millis();
                            } else if (animationState === 'opening') {
                                startClosing();
                                lastStateChange = p.millis();
                            }
                        }

                        if (animationState === 'opening') {
                            animateToTarget();
                        } else if (animationState === 'closing') {
                            animateToTarget();
                        }
                    } else {
                        if (animationState !== 'opening' && animationState !== 'open') {
                            if (!animationActive) {
                                animationActive = true;
                                lastStateChange = p.millis();
                            }

                            if (animationState === 'closed') {
                                startOpening();
                                lastStateChange = p.millis();
                            } else if (animationState === 'closing') {
                                startOpening();
                                lastStateChange = p.millis();
                            }
                        }

                        if (animationState === 'opening') {
                            animateToTarget();
                        } else if (animationState === 'closing') {
                            animateToTarget();
                        }
                    }
                }

                function startOpening() {
                    animationState = 'opening';
                    targetOpenFactor = 1;
                    bounceFactor = 0;
                }

                function startClosing() {
                    animationState = 'closing';
                    targetOpenFactor = 0;
                    bounceFactor = 0;
                }

                function animateToTarget() {
                    let difference = targetOpenFactor - currentOpenFactor;

                    if (p.abs(difference) < 0.001) {
                        currentOpenFactor = targetOpenFactor;

                        if (targetOpenFactor === 1) {
                            animationState = 'open';
                        } else if (targetOpenFactor === 0) {
                            animationState = 'closed';
                        }
                        return;
                    }

                    let easing = 0.15; // Plus rapide pour une animation plus dynamique
                    currentOpenFactor += difference * easing;

                    if (p.abs(difference) < 0.1) {
                        bounceFactor = p.sin(p.frameCount * 10) * 0.02;
                        currentOpenFactor += bounceFactor;
                    }
                }

                function drawBackground() {
                    // Fond noir dramatique pour effet élégant
                    p.background(15, 15, 15); // #0F0F0F en RGB
                }

                function drawUmbrella(openFactor) {
                    p.push();
                    p.translate(centerX, centerY);

                    let segmentAngle = 360 / numSegments;

                    for (let i = 0; i < numSegments; i++) {
                        p.push();
                        p.rotate(i * segmentAngle);

                        let segmentOpenFactor = calculateSegmentOpenFactor(i, openFactor);
                        let segmentColor = p.color(colors[i]);
                        let brightness = p.map(segmentOpenFactor, 0, 1, 0.6, 1);
                        segmentColor = p.lerpColor(segmentColor, p.color(0, 0, 0), 1 - brightness);

                        p.fill(segmentColor);
                        // Contours gris foncés pour se détacher du fond noir
                        p.stroke(80, 80, 80, p.map(segmentOpenFactor, 0, 1, 180, 255));
                        p.strokeWeight(2.5);

                        drawUmbrellaSegment(segmentOpenFactor, segmentAngle);
                        p.pop();
                    }
                    p.pop();
                }

                function calculateSegmentOpenFactor(segmentIndex, globalOpenFactor) {
                    let delay = segmentDelays[segmentIndex];
                    let easedFactor = easeInOutCubic(globalOpenFactor);
                    let delayedFactor = sigmoid((easedFactor - delay) * 8);
                    return p.constrain(delayedFactor, 0, 1);
                }

                function easeInOutCubic(t) {
                    return t < 0.5 ? 4 * t * t * t : 1 - p.pow(-2 * t + 2, 3) / 2;
                }

                function sigmoid(x) {
                    return 1 / (1 + p.exp(-x));
                }

                function drawUmbrellaSegment(openFactor, segmentAngle) {
                    let segmentWidth = segmentAngle * openFactor;
                    let currentRadius = umbrellaRadius * openFactor;

                    p.beginShape();
                    p.vertex(0, 0);

                    for (let a = -segmentWidth/2; a <= segmentWidth/2; a += 2) {
                        let x = p.cos(a) * currentRadius;
                        let y = p.sin(a) * currentRadius;
                        p.vertex(x, y);
                    }

                    p.endShape(p.CLOSE);

                    // Baleines du parapluie avec un rouge plus visible sur fond noir
                    p.stroke(139, 69, 19); // #8B4513 - Brun rouge qui ressort sur noir
                    p.strokeWeight(3.5);
                    p.line(0, 0, p.cos(-segmentWidth/2) * currentRadius, p.sin(-segmentWidth/2) * currentRadius);
                    p.line(0, 0, p.cos(segmentWidth/2) * currentRadius, p.sin(segmentWidth/2) * currentRadius);
                }

                function drawHandle() {
                    // Poignée supprimée pour un look plus épuré
                }
            });
        }

        // Créer le maximum de parapluies possible
        function createMaximumUmbrellas() {
            const container = document.getElementById('canvases-container');
            const canvasSize = 100; // Taille d'un canvas (divisée par 2)
            const gap = 10; // Espace entre les canvas (divisé par 2)
            const totalCanvasSize = canvasSize + gap;

            // Calculer le nombre maximum de canvas qui peuvent tenir
            const availableWidth = window.innerWidth - 40; // Marges
            const availableHeight = window.innerHeight - 40; // Juste les marges (pas de titre)

            const maxCols = Math.floor(availableWidth / totalCanvasSize);
            const maxRows = Math.floor(availableHeight / totalCanvasSize);
            const totalCanvases = Math.min(maxCols * maxRows, 200); // Limite augmentée à 200 grâce aux canvas plus petits

            console.log(`Création de ${totalCanvases} parapluies maximum (${maxCols}x${maxRows} possible)`);

            // Créer les éléments HTML dynamiquement
            for (let i = 0; i < totalCanvases; i++) {
                const wrapper = document.createElement('div');
                wrapper.className = 'canvas-wrapper';

                const canvasDiv = document.createElement('div');
                canvasDiv.id = `sketch-container-${i + 1}`;

                wrapper.appendChild(canvasDiv);
                container.appendChild(wrapper);
            }

            // Créer les instances d'animation
            const umbrellas = [];
            for (let i = 0; i < totalCanvases; i++) {
                umbrellas.push(createUmbrellaAnimation(`sketch-container-${i + 1}`));
            }

            return umbrellas;
        }

        // Créer tous les parapluies
        let allUmbrellas = createMaximumUmbrellas();

        // Gérer le redimensionnement de la fenêtre
        window.addEventListener('resize', function() {
            // Supprimer les anciens canvas
            const container = document.getElementById('canvases-container');
            container.innerHTML = '';

            // Arrêter les anciennes instances p5
            allUmbrellas.forEach(umbrella => {
                if (umbrella && umbrella.remove) {
                    umbrella.remove();
                }
            });

            // Recréer avec les nouvelles dimensions
            allUmbrellas = createMaximumUmbrellas();
        });
    </script>
</body>
</html>

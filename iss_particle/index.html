<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISS Particle Visualization</title>
    <!-- CSS styles for layout and appearance -->
    <style>
        /* Remove default margins and center everything */
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #000;
            color: white;
            font-family: Arial, sans-serif;
        }
        /* Add a subtle border to the canvas */
        canvas {
            border: 1px solid #333;
        }
        /* Position the info display in the top-left corner */
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
        }
    </style>
</head>
<body>
    <!-- Display area for ISS coordinates -->
    <div id="info">ISS Position: Loading...</div>
    
    <!-- Include p5.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
    
    <script>
        // Global variables to store ISS data and timing
        let issData = { latitude: 0, longitude: 0 };
        let particle;
        let lastFetchTime = 0;
        const FETCH_INTERVAL = 15000; // 15 seconds in milliseconds
        let stars = [];
        let pulseSize = 0;
        let isPulsing = false;
        let worldMap;
        let starSpeed = 0.1; // Controls how fast stars move
        let audioContext;
        
        // Function to create ping sound
        function createPingSound() {
            // Create new audio context if it doesn't exist
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            // Create oscillator and gain nodes
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            // Configure oscillator
            oscillator.type = 'sine';
            // Start with lower frequency and slide up slightly for a sonar effect
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4 note
            oscillator.frequency.exponentialRampToValueAtTime(460, audioContext.currentTime + 0.1);
            
            // Configure gain (volume)
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            // Smooth fade in
            gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.1);
            // Long smooth fade out
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 1.0);
            
            // Connect nodes
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Start and stop the sound
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 1.0);
        }

        // Particle class to handle visualization
        class Particle {
            constructor() {
                this.x = width / 2;
                this.y = height / 2;
                this.size = 20;
                this.color = [255, 255, 255];
                this.targetX = this.x;
                this.targetY = this.y;
                this.velocity = createVector(0, 0);
                this.acceleration = createVector(0, 0);
                this.maxSpeed = 2; // Reduced max speed
                this.trail = [];
                this.maxTrailLength = 100; // Longer trail for smoother appearance
            }

            // Update particle properties based on ISS position
            update(lat, lon) {
                // Map longitude (-180 to 180) to canvas width (west to east)
                let x = map(lon, -180, 180, 0, width);
                // Map latitude (-90 to 90) to canvas height (north to south)
                let y = map(lat, 90, -90, 0, height);
                
                // Handle wrapping around the map
                if (x < 0) x = width + x;
                if (x > width) x = x - width;
                
                this.targetX = x;
                this.targetY = y;
                
                // Create attraction force towards target
                let target = createVector(this.targetX, this.targetY);
                let position = createVector(this.x, this.y);
                let force = p5.Vector.sub(target, position);
                force.setMag(0.1); // Reduced force for slower movement
                
                // Apply physics
                this.acceleration = force;
                this.velocity.add(this.acceleration);
                this.velocity.limit(this.maxSpeed);
                
                // Update position
                this.x += this.velocity.x;
                this.y += this.velocity.y;
                
                // Update size and color as before
                this.size = map(Math.abs(lat), 0, 90, 20, 60);
                this.color = [
                    map(lon, -180, 180, 100, 255),
                    map(Math.abs(lat), 0, 90, 100, 255),
                    map(lat, -90, 90, 100, 255)
                ];
                
                // Add current position to trail
                this.trail.push(createVector(this.x, this.y));
                if (this.trail.length > this.maxTrailLength) {
                    this.trail.shift();
                }
            }

            // Draw the particle on the canvas
            display() {
                // Draw trail
                noFill();
                beginShape();
                for (let i = 0; i < this.trail.length; i++) {
                    const alpha = map(i, 0, this.trail.length, 0, 200);
                    stroke(...this.color, alpha);
                    strokeWeight(map(i, 0, this.trail.length, 1, 3));
                    vertex(this.trail[i].x, this.trail[i].y);
                }
                endShape();
                
                // Draw particle
                noStroke();
                // Outer glow
                fill(...this.color, 30);
                ellipse(this.x, this.y, this.size * 2);
                fill(...this.color, 50);
                ellipse(this.x, this.y, this.size * 1.5);
                // Main particle
                fill(...this.color, 200);
                ellipse(this.x, this.y, this.size);
                // Inner highlight
                fill(255, 255, 255, 100);
                ellipse(this.x, this.y, this.size * 0.5);
            }
        }

        // Add this new Star class before the Particle class
        class Star {
            constructor() {
                this.x = random(width);
                this.y = random(height);
                this.size = random(2, 6);  // Much larger stars
                this.twinkleSpeed = random(0.02, 0.05);
                this.brightness = random(100, 255);
                this.angle = random(TWO_PI);
                // Add movement speed with slight variations
                this.speedX = starSpeed + random(-0.05, 0.05);
                this.speedY = starSpeed/2 + random(-0.02, 0.02);
            }

            display() {
                // Update position
                this.x += this.speedX;
                this.y += this.speedY;
                
                // Wrap around screen edges
                if (this.x > width) this.x = 0;
                if (this.x < 0) this.x = width;
                if (this.y > height) this.y = 0;
                if (this.y < 0) this.y = height;

                this.angle += this.twinkleSpeed;
                let twinkle = sin(this.angle) * 50;
                fill(255, this.brightness + twinkle);
                noStroke();
                ellipse(this.x, this.y, this.size);
            }
        }

        // p5.js setup function - runs once at start
        function setup() {
            createCanvas(800, 600);
            particle = new Particle();
            
            // Create stars
            for (let i = 0; i < 200; i++) {
                stars.push(new Star());
            }
            
            // Initial fetch
            fetchISSData();
            
            // Set up interval for regular fetching
            setInterval(fetchISSData, FETCH_INTERVAL);
        }

        // p5.js draw function - runs continuously
        function draw() {
            background(0, 70);  // Changed from (51, 50) to (0, 70) for darker background
            
            // Draw world map with reduced opacity
            drawWorldMap();
            
            // Draw stars
            for (let star of stars) {
                star.display();
            }
            
            // Draw pulse effect when new data is received
            if (isPulsing) {
                noFill();
                stroke(particle.color[0], particle.color[1], particle.color[2], 255 - pulseSize);
                strokeWeight(2);
                ellipse(particle.x, particle.y, pulseSize);
                pulseSize += 5;
                
                if (pulseSize > 200) {
                    isPulsing = false;
                    pulseSize = 0;
                }
            }

            // Update and display particle
            particle.update(issData.latitude, issData.longitude);
            particle.display();
        }

        // Function to fetch ISS position data
        async function fetchISSData() {
            try {
                const response = await fetch('http://api.open-notify.org/iss-now.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // Update stored position data
                issData.latitude = parseFloat(data.iss_position.latitude);
                issData.longitude = parseFloat(data.iss_position.longitude);
                
                // Trigger pulse effect
                isPulsing = true;
                pulseSize = 0;
                
                // Play ping sound
                createPingSound();
                
                // Update display
                document.getElementById('info').innerText = 
                    `ISS Position: Lat ${issData.latitude.toFixed(2)}, Lon ${issData.longitude.toFixed(2)}`;
                
                lastFetchTime = millis();
            } catch (error) {
                console.error('Error fetching ISS data:', error);
                document.getElementById('info').innerText = 
                    `ISS Position: Error fetching data - ${error.message}`;
            }
        }

        // Add this new function to draw the world map
        function drawWorldMap() {
            stroke(50, 150, 200, 40);  // Reduced opacity from 80 to 40
            noFill();
            strokeWeight(1.5);
            
            // Draw simplified line-art continents
            // North America
            beginShape();
            vertex(100, 100);
            vertex(200, 80);
            vertex(250, 120);
            vertex(200, 180);
            vertex(150, 200);
            endShape(CLOSE);
            
            // South America
            beginShape();
            vertex(180, 250);
            vertex(220, 280);
            vertex(200, 400);
            vertex(180, 450);
            vertex(160, 350);
            endShape(CLOSE);
            
            // Europe
            beginShape();
            vertex(350, 80);
            vertex(400, 100);
            vertex(450, 120);
            vertex(400, 150);
            vertex(380, 130);
            endShape(CLOSE);
            
            // Africa
            beginShape();
            vertex(350, 180);
            vertex(420, 200);
            vertex(450, 300);
            vertex(400, 400);
            vertex(350, 350);
            endShape(CLOSE);
            
            // Asia
            beginShape();
            vertex(450, 80);
            vertex(600, 100);
            vertex(650, 150);
            vertex(700, 200);
            vertex(600, 250);
            vertex(500, 200);
            endShape(CLOSE);
            
            // Australia
            beginShape();
            vertex(600, 300);
            vertex(700, 320);
            vertex(680, 380);
            vertex(600, 370);
            endShape(CLOSE);
            
            // Antarctica
            beginShape();
            vertex(200, 500);
            vertex(300, 520);
            vertex(400, 520);
            vertex(500, 510);
            vertex(600, 500);
            vertex(400, 480);
            endShape(CLOSE);
            
            // Greenland
            beginShape();
            vertex(280, 50);
            vertex(350, 40);
            vertex(320, 80);
            vertex(280, 70);
            endShape(CLOSE);

            // Draw oceans labels
            fill(50, 150, 200, 40);  // Reduced opacity from 80 to 40
            noStroke();
            textSize(14);
            text("Pacific Ocean", 650, 200);
            text("Atlantic Ocean", 250, 200);
            text("Indian Ocean", 450, 250);
            text("Southern Ocean", 400, 450);

            // Draw latitude/longitude grid
            stroke(50, 150, 200, 15);  // Reduced opacity from 30 to 15
            strokeWeight(0.5);
            
            // Draw fewer, more spaced out grid lines
            for (let y = 0; y < height; y += height/6) {
                line(0, y, width, y);
            }
            
            for (let x = 0; x < width; x += width/8) {
                line(x, 0, x, height);
            }
        }
    </script>
</body>
</html> 